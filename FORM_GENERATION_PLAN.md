# План: Автогенерация форм из ППО (Domain Concept)

## Цель

Генерировать Client Type (структуру форм) из дерева ППО, чтобы затем запускать демо-режим с отображением списка и детальной формы — аналогично form-builder.

---

## Моё понимание

### 1. Маппинг структуры → Client Type

**Терминология:**
- **Subject Area** = Предметная область (контейнер/папка)
- **Domain Concept** = ППО (Понятие Предметной Области) — атрибуты, списки

| Элемент | Client Type (Form Builder) |
|---------|---------------------------|
| Subject Area (терминальная) | Корневой Client Type (item_type='section') |
| Domain Concept (список/list) | Секция с формой-гридом (item_type='form') |
| Domain Concept (атрибут) | Поле формы (input/select/date/etc) |
| Domain Concept (атрибут от ППО) | НЕ рендерится напрямую — само ППО это будущее поле |
| Reference на концепте | Select с данными из справочника |
| Дочерние концепты под reference | Поля автозаполнения при выборе справочника |

### 2. Иерархия преобразования

```
ППО: Физлицо-тест (терминальная Subject Area)
├── Фамилия (attribute, text)           → TextField
├── Имя (attribute, text)               → TextField
├── Отчество (attribute, text)          → TextField
├── Дата рождения (attribute, date)     → DatePicker
├── Статус (attribute, select)          → Select с options
├── Документ (attribute + reference)    → Select из справочника "Типы документов"
│   └── Номер документа (child attr)    → TextField (маппится на поле справочника)
├── Родственники (list)                 → Grid/DataTable
│   ├── ФИО (child attribute)           → Колонка грида
│   ├── Степень родства (child + ref)   → Колонка-select из справочника
│   └── Дата рождения (child attr)      → Колонка-date
└── Адреса (list)                       → Grid/DataTable
    ├── Тип адреса (child + ref)        → Колонка-select
    └── Адрес (child attribute)         → Колонка-text
```

### 3. Что показывать в списке (List View)

Поскольку нет флага "показывать всегда", нужна логика выбора полей для списка:
- **Приоритет 1:** Поля с именами содержащими "фамилия", "имя", "название", "name"
- **Приоритет 2:** Первые 3-4 атрибута верхнего уровня (не вложенные в list)
- **Приоритет 3:** Поле "статус" или "состояние" если есть
- **Исключения:** Списки (list) не показываются в колонках

### 4. Рендеринг форм

#### Типы данных → Компоненты:
| data_type | Компонент |
|-----------|-----------|
| text | TextField |
| number | NumberField |
| date | DatePicker |
| money | TextField (с форматированием) |
| boolean | Checkbox |
| select | Select (с select_options) |

#### Справочники (reference_id):
- Рендерится как Select/Autocomplete
- Показывается `name` из справочника, сохраняется `id`
- Дочерние поля с `reference_field_id` — автозаполняются при выборе

#### Списки (concept_type='list'):
- Рендерится как DataGrid/Table
- Дочерние атрибуты становятся колонками
- Кнопки "Добавить строку", "Удалить"

### 5. Атрибуты от ППО (ppo_attribute)

**НЕ рендерятся напрямую!**

Это ссылка на другое ППО, которое само станет полем в будущем. На данном этапе:
- Можно игнорировать при рендеринге
- Или показывать как placeholder "Ссылка на ППО: [название]"

---

## План реализации

### Этап 1: Подготовка данных (Backend)

1. **API для генерации Client Type из ППО:**
   ```
   POST /api/subject-areas/{area_id}/generate-client-type
   ```
   - Принимает ID терминальной Subject Area
   - Возвращает структуру Client Type (JSON)
   - Не сохраняет в базу form-builder

2. **API для получения полей формы:**
   ```
   GET /api/subject-areas/{area_id}/form-fields
   ```
   - Возвращает плоский список полей для списочного представления
   - Включает логику выбора "важных" полей

### Этап 2: Демо-кнопка (Frontend)

1. **Toolbar:** Добавить кнопку "Демо" (PlayArrow icon)
   - Активна только когда выбрана терминальная Subject Area
   - При клике открывает демо-режим

2. **Состояние:**
   ```typescript
   const [demoMode, setDemoMode] = useState<'off' | 'list' | 'detail'>('off');
   const [demoData, setDemoData] = useState<any[]>([]);
   const [selectedDemoItem, setSelectedDemoItem] = useState<any>(null);
   ```

### Этап 3: List View (Frontend)

1. **Компонент `PPOListView`:**
   - Получает список полей для отображения
   - Генерирует тестовые данные (или API для генерации)
   - Отображает таблицу с данными
   - Кнопки: "Сгенерировать данные", "Добавить", "Редактировать", "Удалить"

2. **Генерация данных:**
   - Использовать логику из form-builder (celebrity names, etc)
   - Или упрощённо: faker-подобная генерация

### Этап 4: Detail View (Frontend)

1. **Компонент `PPODetailView`:**
   - Левая панель: дерево ППО (только списки как секции)
   - Правая панель: форма редактирования

2. **Компонент `PPOFormRenderer`:**
   - Рендерит форму по структуре Domain Concepts
   - Поддержка всех типов данных
   - Reference picker для справочников
   - DataGrid для списков

### Этап 5: Создание тестового ППО "Физлицо-тест"

Создать структуру ППО максимально похожую на Client Type "Физлицо" из form-builder:

```
Физлицо-тест (Subject Area)
├── Фамилия (text)
├── Имя (text)
├── Отчество (text)
├── Дата рождения (date)
├── Статус (select: Активен, Заблокирован, В обработке)
├── Тип документа (reference: Типы документов)
│   └── Номер документа (text, mapped to reference field)
├── Родственники (list)
│   ├── ФИО родственника (text)
│   ├── Степень родства (reference: Степени родства)
│   └── Дата рождения (date)
└── Адреса (list)
    ├── Тип адреса (reference: Типы адресов)
    └── Адрес (text)
```

---

## Структура файлов

```
frontend/src/
├── components/
│   ├── PPOListView.tsx          # Список записей
│   ├── PPODetailView.tsx        # Детальная форма
│   ├── PPOFormRenderer.tsx      # Рендерер полей формы
│   └── PPODemoToolbar.tsx       # Кнопки демо-режима
├── store/
│   └── demoStore.ts             # Состояние демо-режима
└── utils/
    └── ppoToForm.ts             # Конвертация ППО → структура формы
```

---

## Решения по архитектуре

### Микросервисная связь

```
┌─────────────────────┐         ┌─────────────────────┐
│  Subject Area Editor │ ──────► │    Form Builder     │
│       (PPO)          │         │   (микросервис)     │
└─────────────────────┘         └─────────────────────┘
         │                               │
         ▼                               ▼
   ┌───────────┐                  ┌───────────┐
   │  Своя БД  │                  │  Своя БД  │
   │ (SQLite)  │                  │ (SQLite)  │
   └───────────┘                  └───────────┘
```

- **PPO знает о form-builder** — может вызывать его API
- **Form-builder НЕ знает о PPO** — полностью независим
- Односторонняя связь

### Справочники

Используем **свои справочники** из БД subject-area-editor:
- Таблицы `references`, `reference_fields`, `reference_data` уже есть
- Данные скопированы из form-builder
- Независимость для базовых операций

### Генерация данных

Вызываем **API form-builder** для генерации демо-данных:
- `POST http://localhost:8000/api/client-data/{client_type_id}/generate`
- Либо реализуем свой генератор (проще, меньше зависимостей)

### Демо-режим

**Только просмотр** — без сохранения в БД.

### Группировка

**Секции** — простые разделители с заголовками, без tabs/accordion.

---

## Следующие шаги

1. [ ] Создать справочники: "Типы документов", "Степени родства", "Типы адресов"
2. [x] Создать ППО "Физлицо-тест" со структурой выше
3. [x] Добавить кнопку "Демо" в toolbar
4. [x] Реализовать PPOListView (в составе PPODemoView)
5. [x] Реализовать PPODetailView (в составе PPODemoView)
6. [x] Реализовать PPOFormRenderer (в составе PPODemoView)

## Что реализовано

### Созданные файлы:
- `frontend/src/components/PPODemoView.tsx` - компонент демо-режима (список + детализация)
- `frontend/src/components/PPODemoView.css` - стили демо-режима

### Изменения в App.tsx:
- Добавлена кнопка "Демо" в toolbar (активна только для терминальных ППО)
- Добавлено состояние демо-режима (demoMode, demoData, selectedDemoItem, demoLoading)
- Добавлена функция generateDemoData() для генерации тестовых данных
- Добавлена функция generateFieldValue() для умной генерации значений полей
- PPODemoView интегрирован в основной layout

### Созданное тестовое ППО "Физлицо-тест":
- Фото, Код, Дата регистрации, Дата закрытия
- Фамилия, Имя, Отчество, Дата рождения
- Категория (select), Состояние (select)
- Адреса (list): Тип адреса, Страна, Город, Улица, Дом, Квартира, Индекс
- Документы (list): Тип документа, Серия, Номер, Дата выдачи, Кем выдан
- Контакты (list): Тип контакта, Значение, Основной

### Запущенные сервисы:
- subject-area-editor backend: http://localhost:8001
- subject-area-editor frontend: http://localhost:5173
- form-builder backend: http://localhost:8000
- form-builder frontend: http://localhost:5174
